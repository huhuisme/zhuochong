name: Build macOS DMG

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Generate ICNS icon
      run: |
        mkdir -p target
        mkdir icon.iconset
        
        sips -z 16 16     src/main/resources/images/icon.png --out icon.iconset/icon_16x16.png
        sips -z 32 32     src/main/resources/images/icon.png --out icon.iconset/icon_16x16@2x.png
        sips -z 32 32     src/main/resources/images/icon.png --out icon.iconset/icon_32x32.png
        sips -z 64 64     src/main/resources/images/icon.png --out icon.iconset/icon_32x32@2x.png
        sips -z 128 128   src/main/resources/images/icon.png --out icon.iconset/icon_128x128.png
        sips -z 256 256   src/main/resources/images/icon.png --out icon.iconset/icon_128x128@2x.png
        sips -z 256 256   src/main/resources/images/icon.png --out icon.iconset/icon_256x256.png
        sips -z 512 512   src/main/resources/images/icon.png --out icon.iconset/icon_256x256@2x.png
        sips -z 512 512   src/main/resources/images/icon.png --out icon.iconset/icon_512x512.png
        sips -z 1024 1024 src/main/resources/images/icon.png --out icon.iconset/icon_512x512@2x.png
        
        iconutil -c icns icon.iconset -o target/deskpet.icns
        
        rm -rf icon.iconset
        
    - name: Build with Maven
      run: |
        mvn clean package
        
        
    - name: Create custom JRE
      run: |
        # 分析依赖模块
        modules=$(jdeps --ignore-missing-deps --print-module-deps -q target/DeskPet-1.0-SNAPSHOT.jar)
        
        # 创建精简JRE
        jlink --add-modules $modules,java.desktop \
              --strip-debug \
              --no-header-files \
              --no-man-pages \
              --compress=2 \
              --output target/custom-jre
              
    - name: Package DMG
      run: |
        jpackage --name DeskPet \
                 --input target/ \
                 --main-jar DeskPet-1.0-SNAPSHOT.jar \
                 --main-class com.hhhu.DesktopPet \
                 --runtime-image target/custom-jre \
                 --icon target/deskpet.icns \
                 --type dmg \
                 --dest release \
                 --app-version "1.0.0" \
                 --mac-package-identifier "com.hhhu.DeskPet"
                 
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeskPet-Mac
        path: release/DeskPet-*.dmg